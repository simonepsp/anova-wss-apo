<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anova WebSocket Client</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    input, button, textarea { font-size: 16px; margin-top: 10px; width: 100%; padding: 8px; }
    textarea { height: 100px; resize: vertical; }
    #log { white-space: pre-wrap; background: #222; color: #0f0; padding: 10px; height: 500px; overflow-y: auto; }
    #updateBtn { margin-top: 10px; background: #007bff; color: white; border: none; padding: 10px; font-weight: bold; cursor: pointer; display: none; }
    .container { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
    .info, .donation { flex: 1; }
    .donation { text-align: donation; }
    .donation img { max-width: 150px; margin: 0 auto 10px; display: block; height: auto; }
  </style>
</head>
<body>
  <div class="container">
    <div class="info">
      <h2>Anova Self-Service Websocket Client</h2>
      <h3>github.com/simonepsp</h3>
    </div>
    <div class="donation">
      <h5>
        Please consider a small BTC donation if this tool saved your oven <3<br>
        BTC Address: bc1qd46574fhplmjzz78nxhwrjddjpm8sdtrrwk7u6
        <img src="img/wallet.png" alt="bc1qd46574fhplmjzz78nxhwrjddjpm8sdtrrwk7u6" />
      </h5>
    </div>
  </div>
  <h3>[Recommended] Login with Anova email / password</h3>
  <small>Please note that due to <b>CORS security policies</b>, I had to rely on a proxy. For security, I recommend changing your Anova credentials after using this tool.</small><br><br>
  <label>Email: <input type="email" id="email" placeholder="Your Anova email" /></label><br><br>
  <label>Password: <input type="password" id="password" placeholder="Password"/></label>
  <button id="anovaLoginBtn">Log in and retrieve access token</button>
  <br><br>

  <details>
    <summary>Refresh Token (Anova dashboard) <a href="https://github.com/bogd/anova-oven-api/blob/main/docs/README.md#getting-the-refresh-token" target="_blank">[How to]</a></summary>
    <label for="refreshToken"></label>
    <input type="text" id="refreshToken" placeholder="Enter Anova Refresh Token (if you already know it)" />
  </details>
  
  <br><br>
  <h5>Access Token</h5>
  <input type="text" id="idToken" placeholder="Anova access token (do not use the personal token generated in the app)" />
  <button id="connectBtn">Connect to your APO</button>

  <h3>Send Command (JSON):</h3>
  <small>See some of the available commands <a href="https://github.com/bogd/anova-oven-api/tree/main/docs/oven" target="_blank">here</a>
  <textarea id="commandInput" placeholder='{"command":"...","payload":{"type":"...","id":"<your_oven_id>"},"requestId":"<uuid>"}'></textarea>
  <button id="sendBtn">Send Command</button>

  <button id="updateBtn"></button>

  <h3>Log:</h3>
  <div id="log"></div>

  <script>
    const FIREBASE_API_KEY = "AIzaSyB0VNqmJVAeR1fn_NbqqhwSytyMOZ_JO9c";

    let ws = null;
    let lastFirmware = null;

    function log(message) {
      const logDiv = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      logDiv.textContent += `[${time}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

        async function signInWithEmailPassword(email, password) {
      // Use the special API key for login
      const LOGIN_API_KEY = "AIzaSyCGJwHXUhkNBdPkH3OAkjc9-3xMMjvanfU";
      const targetUrl = `https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${LOGIN_API_KEY}`;
      const proxyUrl = `https://corsproxy.io/?` + encodeURIComponent(targetUrl);

      const body = {
        email,
        password,
        returnSecureToken: true,
      };

      const response = await fetch(proxyUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!response.ok) {
        const errData = await response.json();
        throw new Error(errData.error.message || "Failed to login");
      }

      const data = await response.json();
      document.getElementById("idToken").value = data.idToken;
    }

    async function getIdTokenFromRefresh(refreshToken) {
      const url = `https://securetoken.googleapis.com/v1/token?key=${FIREBASE_API_KEY}`;
      const body = new URLSearchParams({
        grant_type: "refresh_token",
        refresh_token: refreshToken
      });

      const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString()
      });

      if (!resp.ok) {
        throw new Error(`Token refresh failed: ${resp.status} ${resp.statusText}`);
      }

      const data = await resp.json();
      return data.id_token;
    }

    function generateUUID() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11)
    .replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
    }

    function connectWebSocket(idToken) {
      const accessories = "APO";
      const platform = "ios";
      const url = `wss://devices.anovaculinary.io?token=${idToken}&supportedAccessories=${accessories}&platform=${platform}`;

      ws = new WebSocket(url, "ANOVA_V2");

      ws.onopen = () => {
        log("üîó WebSocket connected.");
      };

      ws.onmessage = async event => {
        try {
          const json = JSON.parse(event.data);
          log("üì® Message received:\n" + JSON.stringify(json, null, 2));

          if (json.command === "EVENT_APO_WIFI_FIRMWARE_UPDATE" && json.payload?.ota?.available) {
            const version = json.payload.ota.version || "unknown";
            const description = json.payload.ota.description || "No description";
            lastFirmware = {
              version,
              description,
              url: json.payload.ota.url,
              cookerId: json.payload.cookerId
            };

            log(`‚öôÔ∏è New firmware detected: version ${version} - ${description}`);

            const updateBtn = document.getElementById("updateBtn");
            updateBtn.textContent = `UPDATE to ${version}`;
            updateBtn.style.display = "block";
          }

        } catch {
          log("üì® Message received:\n" + event.data);
        }
      };

      ws.onerror = event => {
        log("‚ùå WebSocket error.");
        console.error(event);
      };

      ws.onclose = (event) => {
        log(`üîå Connection closed (${event.code}): ${event.reason}`);
        document.getElementById("updateBtn").style.display = "none";
      };
    }

    async function sendCommand() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log("‚ö†Ô∏è WebSocket is not connected.");
        return;
      }

      const input = document.getElementById("commandInput").value;
      try {
        const json = JSON.parse(input);
        if (!json.requestId) {
          json.requestId = crypto.randomUUID();
        }
        ws.send(JSON.stringify(json));
        log("‚û°Ô∏è Sent command:\n" + JSON.stringify(json, null, 2));
      } catch (e) {
        log("‚ùå Invalid JSON command.");
      }
    }

    async function doFirmwareUpdate() {
      if (!lastFirmware) {
        log("‚ö†Ô∏è No firmware info available.");
        return;
      }

      log(`‚¨áÔ∏è Fetching firmware manifest from ${lastFirmware.url}...`);
      try {
        const response = await fetch("https://corsproxy.io/?" + encodeURIComponent(lastFirmware.url));
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);

        const manifest = await response.json();
        const downloadLink = manifest["download-link-full-ota"];

        if (!downloadLink) {
          log("‚ùå Firmware manifest does not contain 'download-link-full-ota'");
          return;
        }

        const command = {
          command: "CMD_APO_OTA",
          payload: {
            id: lastFirmware.cookerId,
            type: "CMD_APO_OTA",
            payload: {
              downloadLink: downloadLink
            }
          },
          requestId: generateUUID()
        };

        log("üì§ Sending OTA command: " + JSON.stringify(command));
        ws.send(JSON.stringify(command));
        log(`‚û°Ô∏è Sent OTA command with downloadLink: ${downloadLink}`);

      } catch (err) {
        log("‚ùå Error fetching/parsing firmware manifest: " + err.message);
      }
    }

    document.getElementById("anovaLoginBtn").onclick = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      if (email && password) {
            log("üîê Logging in with email and password...");
            idToken = await signInWithEmailPassword(email, password);
            log("‚úÖ Got Access / ID token from Anova");
      } else {
        alert("Please enter email and password");
        return;
      }
    }

    document.getElementById("connectBtn").onclick = async () => {
      const refreshToken = document.getElementById("refreshToken").value.trim();
      const idTokenInput = document.getElementById("idToken").value.trim();

      try {
        let idToken = idTokenInput;

        if (!idToken && refreshToken) {
          log("‚è≥ Using refresh token to get ID token...");
          idToken = await getIdTokenFromRefresh(refreshToken);
          log("‚úÖ Got ID token from refresh.");
        }

        if (!idToken) {
          alert("Please enter  Refresh Token or ID Token.");
          return;
        }

        log("üîê Connecting with ID token...");
        connectWebSocket(idToken);

      } catch (err) {
        log("‚ùå Login failed: " + err.message);
      }
    };

    document.getElementById("sendBtn").onclick = sendCommand;
    document.getElementById("updateBtn").onclick = doFirmwareUpdate;
  </script>
  <p><strong>Disclaimer:</strong> This tool is an independent project and is not affiliated with, endorsed by, or supported by Anova Culinary or its parent companies. All trademarks and brand names are the property of their respective owners.</p>
</body>
</html>
